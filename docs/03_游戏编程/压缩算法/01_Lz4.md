## 概述

LZ4 是一种无损压缩算法，提供每核 > 500 MB/s 的压缩速度，并可通过多核 CPU 进行扩展。它具有极快的解码器，每核速度可达数 GB/s，通常会达到多核系统的 RAM 速度极限。

作为 Unity AssetBundle 主推的压缩算法，它相比 Lzma 拥有更快的速度（大约是 Lzma 的十倍以上）。并且是基于块压缩的（Chunk Based），可以按需选择加载部分块，而不用将整个文件全部加载，这对于内存来说是更友好的。唯一相较于 Lzma 的劣势是压缩率，大约比 Lzma 高出 30%

## Lz4 的原理

Lz4 压缩后的文件由块组成，每一个压缩块则由若干序列组成，它的核心原理简单概括就是找出重复的字节序列，按照固定规则以更省空间的形式存储。先来看它的序列示意图：

![Lz4的序列](Lz4_Sequence.png)
/// caption
Lz4的序列
///

首先，开头的一个字节称为一个标记（Token），这个标记由两个 4 位组成（因此值的范围从 0 到 15）

高 4 位用于存储字面量（Literal）的长度，字面量是指压缩过程中无法被压缩的原始字节。由于 4 位能表示的值范围有限，因此图中 Literal length+ （图中黄色区域）用于支持更大的长度值的存储，这是一个可选的区域。如果 4 位之内足够存储字面量的长度，这个区域就不存在，Token 之后会紧跟 Literals（字面量）。如果该 4 位存储的值为 0，则代表没有字面量。如果为 15（4 位全 1），则增加一个 Literal length+ 区域，其代表的值为 0 - 255（一个字节的大小），此时字面量的长度 = 15 + 这个字节的值。如果这个字节的值仍然满了（255），则继续增加一个新的字节，直到可以表示字面量的长度为止。（因此图中写的是 0-n bytes）

这两个区域之后，则是字面量的存储区域，字面量是未压缩的字节，按原样复制。

紧接着是偏移量（Offset），这是一个两个字节的值（0-65535），它表示要从中复制匹配的位置。请注意，0 是无效值，不会被使用。1 表示“当前位置 - 1 字节”，另外需要注意，这个值使用小端格式存储（低位在前，高位在后）。通过偏移量，我们可以得到重复字节的起始位置

我们使用重复字节的起始位置加上匹配长度的值，就可以得到重复位置从哪个位置开始到哪个位置结束。匹配长度是指从在 Token 的低 4 位值存储，如果不够，再启用后面的可选区域，可选区域的规则和字面量长度的规则一致，但这里有一点细小的差异，匹配长度要求最小值为 4，也就是说至少要 4 个重复的字节才可以压缩，这应该是为了压缩率至少不能超过 1 而设计的，毕竟压缩后变大了是不行的。这里存储的值如果为 0，代表匹配长度为 4 个字节，如果值为 15，代表匹配长度为 19+ 个字节（可能启用了可选区域）

## 进行一次计算

![原始字节序列](Lz4_Exp.drawio.png)
/// caption
原始字节序列
///

假设我们有上面这个字节序列，其中每个字节编号一个索引，最大值是F（11111111），现在开始对它进行模拟压缩，步骤如下：

![模拟压缩步骤](Lz4.drawio.png)
/// caption
模拟压缩步骤
///

### 压缩计算

现在我们得到：

- 字面量为[C, C, C, A, B, C, D, E, F, B, B, B]，长度为12。
- 偏移量为9
- 匹配长度为6

首先第一个序列用来存储字面量：

```text
Token：
- 高 4 位：12（字面量长度，小于 15 无需额外字节）
- 低 4 位：0（不存储匹配）
Literals：[C, C, C, A, B, C, D, E, F, B, B, B]
Offset：由于该序列仅表示字面量，因此不存储Offset
```

第二个序列用来存储匹配数据：

```text
匹配信息:
- 偏移量: 9
- 匹配长度: 6
Token:
- 高4位: 0 (没有字面量)
- 低4位: 2 (匹配长度 = 6-4 = 2)
Token = 0x02
偏移量编码: 0x0009 → 小端序 [0x09][0x00]
```

得到最终压缩结果：

```text
[0xC0][C][C][C][A][B][C][D][E][F][B][B][B][0x02][0x09][0x00]

原始数据: 18字节
压缩数据: 16字节
压缩率: 16/18 ≈ 88.9%
节省: 2字节 (11.1%)
```

### 解压计算

解压Token1 (0xC0)：

```text
字面量长度: 12
匹配长度: 0
操作: 复制12个字面量
输出: C C C A B C D E F B B B
```

解压Token2 (0x02)：

```text
字面量长度: 0
匹配长度: 2+4 = 6
偏移量: 9
操作: 从位置3开始复制6个字节
输出: A B C D E F (复制位置3-8)
```

最终结果与原数据一致：

```
C C C A B C D E F B B B A B C D E F
```